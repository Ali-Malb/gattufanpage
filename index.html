<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gattu's Global Fan Page</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); 
            color: #333; 
            margin: 0; padding: 0; 
            user-select: none; text-align: center;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(45deg, #e91e63, #ff4081);
            color: white; padding: 40px 0;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
            margin-bottom: 30px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }

        h1 { margin: 0; font-family: 'Fredoka One', cursive; font-size: 3em; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        h2 { color: #880e4f; font-weight: 600; }

        .container { max-width: 800px; margin: 0 auto; padding: 0 20px 50px 20px; }

        .section-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px; border-radius: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px; border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
        }

        /* --- AI STATUS INDICATOR --- */
        #ai-status {
            font-size: 12px; font-weight: bold; color: #2196F3;
            margin-bottom: 10px; display: inline-block;
            background: #e3f2fd; padding: 5px 10px; border-radius: 20px;
        }

        /* --- GAME & UI --- */
        .gattu-img { width: 100%; max-width: 250px; border-radius: 20px; border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; transition: transform 0.3s; }
        .gattu-img:hover { transform: scale(1.02) rotate(1deg); }

        .love-btn, .action-btn { 
            background: linear-gradient(45deg, #ff4081, #f50057);
            color: white; border: none; padding: 15px 40px;
            font-size: 20px; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 20px rgba(245, 0, 87, 0.4);
            transition: all 0.2s;
        }
        .action-btn { background: linear-gradient(45deg, #2196F3, #21CBF3); font-size: 16px; border-radius: 10px; padding: 12px 25px; }
        
        button:disabled { background: #ccc !important; cursor: not-allowed; transform: none !important; box-shadow: none; }

        .score-display { font-family: 'Fredoka One', cursive; font-size: 3.5em; color: #d81b60; margin: 10px 0; text-shadow: 2px 2px 0px rgba(255,255,255,0.5); }

        .clicker-btn { 
            width: 160px; height: 160px; border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #ff80ab 0%, #d81b60 100%);
            border: 6px solid white; box-shadow: 0 10px 30px rgba(216, 27, 96, 0.5); 
            color: white; font-size: 50px; cursor: pointer; 
            transition: transform 0.05s; animation: pulse 2s infinite;
        }
        .clicker-btn:active { transform: scale(0.9) !important; animation: none; }
        @keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.05)} 100% {transform:scale(1)} }

        input, textarea { padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 70%; text-align: center; font-family: 'Poppins', sans-serif; font-size: 16px; transition: all 0.3s; }
        textarea { width: 80%; text-align: left; }
        
        /* Red border when AI detects toxicity */
        .toxic-alert { border-color: red !important; background-color: #ffebee; }

        /* Shop & Table */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 25px; }
        .shop-item { background: white; padding: 15px; border-radius: 15px; border: 2px solid #f8bbd0; cursor: pointer; }
        .shop-item:hover { border-color: #e91e63; transform: translateY(-3px); }
        .shop-item.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        table { width: 100%; margin-top: 15px; border-collapse: separate; border-spacing: 0 8px; }
        td { background: white; padding: 15px; border-radius: 10px; }
        
        /* Floating Text */
        .floating-text { position: absolute; color: #d81b60; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 1s forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        
        #golden-heart { position: absolute; display: none; font-size: 40px; cursor: pointer; z-index: 100; animation: floatUp 3s infinite; }
    </style>
</head>
<body>

    <header>
        <h1>üåü The Gattu Fan Club üåü</h1>
    </header>

    <div class="container">
        
        <div id="ai-status">‚è≥ Loading AI Filter...</div>

        <div class="section-card">
            <h2>Show Your Support</h2>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6RZlboeF2Q-nIeNB-U1s88DFOmsVlCo3W0w&s" class="gattu-img" alt="Gattu">
            
            <input type="text" id="letter-name" placeholder="Your Name"><br><br>
            <textarea id="letter-msg" placeholder="Your Message..." rows="3"></textarea><br>
            
            <button class="love-btn" id="love-btn" onclick="sendLove()" disabled>‚ù§Ô∏è Send Love</button>
            <div id="love-status" style="margin-top: 15px; font-weight: 600; color: #880e4f;"></div>
        </div>

        <div class="section-card" id="game-area">
            <h2 class="game-title">üéÆ Global Fan Clicker</h2>
            <div id="golden-heart" onclick="clickGoldenHeart(event)">üíõ</div>

            <div class="score-display">‚ù§Ô∏è <span id="score">0</span></div>
            <div style="color: #666; font-size: 0.9em; margin-bottom: 25px;">
                Generating <span id="gps" style="font-weight:bold; color:#d81b60;">0</span> / sec
            </div>

            <button class="clicker-btn" onclick="clickHeart(event)">‚ù§Ô∏è</button>

            <h3 style="margin-top: 30px; text-align: left;">üõí Upgrade Shop</h3>
            <div id="shop" class="shop-grid"></div>

            <div style="background: #e1f5fe; padding: 25px; border-radius: 20px; margin-top: 40px; border: 2px solid #b3e5fc;">
                <h3>üåç Global Leaderboard</h3>
                <p style="font-size: 0.85em; color: #555;">AI Filter Active. One entry per device.</p>
                
                <input type="text" id="gamer-name" placeholder="Enter Your Username">
                <br>
                <button id="upload-btn" class="action-btn" onclick="window.pushScoreToFirebase()" disabled>
                    Update My Rank
                </button>
                <p id="upload-status" style="font-size: 14px; color: #555; margin-top:10px;"></p>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                <h3>Top 10 Fans</h3>
                <button onclick="window.fetchLeaderboard()" style="background:none; border:none; color:#2196F3; cursor:pointer; font-weight:600;">‚Üª Refresh</button>
            </div>
            <table>
                <thead><tr><th>Rank</th><th>Fan</th><th>Score</th></tr></thead>
                <tbody id="leaderboard-body"><tr><td colspan="3">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        const EMAIL_SERVICE_ID = 'service_11ijhua';
        const EMAIL_TEMPLATE_ID = 'template_mwe3jti';
        const EMAIL_PUBLIC_KEY = 'iwl1W3R_eIaaqB7RR';

        // --- üß† AI FILTER SETUP (TensorFlow) ---
        let toxicityModel = null;
        const threshold = 0.85; // How strict the AI is (0.9 is very strict)

        // Load the AI Model
        toxicity.load(threshold).then(model => {
            toxicityModel = model;
            document.getElementById('ai-status').innerText = "‚úÖ AI Filter Active";
            document.getElementById('ai-status').style.background = "#dcedc8";
            document.getElementById('ai-status').style.color = "#33691e";
            
            // Enable buttons now that AI is ready
            document.getElementById('love-btn').disabled = false;
            document.getElementById('upload-btn').disabled = false;
        });

        // Function to Check Text using AI
        async function checkTextForToxicity(text) {
            if (!toxicityModel) return false; // If AI failed to load, let it pass (or block, your choice)
            
            console.log("AI Analyzing:", text);
            const predictions = await toxicityModel.classify([text]);
            
            // Check results
            for (const prediction of predictions) {
                if (prediction.results[0].match) {
                    return true; // IT IS TOXIC
                }
            }
            return false; // IT IS CLEAN
        }

        // --- DEVICE ID ---
        let deviceID = localStorage.getItem('gattu_device_id');
        if (!deviceID) {
            deviceID = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('gattu_device_id', deviceID);
        }

        // --- GAME DATA ---
        let game = { 
            score: 0, gps: 0, clickPower: 1, 
            items: [
                { id: 0, name: "Gattu's Vocab", cost: 50, rate: 0, clickBoost: 5, desc: "+5 per click", count: 0 },
                { id: 1, name: "Gattu's Notebook", cost: 100, rate: 2, clickBoost: 0, desc: "+2 / sec", count: 0 },
                { id: 2, name: "Gattu's Dog", cost: 500, rate: 15, clickBoost: 0, desc: "+15 / sec", count: 0 },
                { id: 3, name: "Gaming Setup", cost: 2000, rate: 50, clickBoost: 0, desc: "+50 / sec", count: 0 },
                { id: 4, name: "Gattu's Car", cost: 10000, rate: 250, clickBoost: 0, desc: "+250 / sec", count: 0 }
            ]
        };

        if(localStorage.getItem('gattuGameData')) {
            let saved = JSON.parse(localStorage.getItem('gattuGameData'));
            game = { ...game, ...saved };
        }
        if(localStorage.getItem('gattuUserName')) document.getElementById('gamer-name').value = localStorage.getItem('gattuUserName');

        // --- UI & GAME ---
        function initUI() {
            const shopDiv = document.getElementById('shop');
            shopDiv.innerHTML = "";
            game.items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                el.id = `item-box-${item.id}`;
                el.onclick = () => buyItem(item.id);
                el.innerHTML = `
                    <div style="font-weight: bold;">${item.name}</div>
                    <div style="color: #666; font-size: 0.9em;">Owned: <span id="count-${item.id}">${item.count}</span></div>
                    <div style="color: #d81b60; font-weight:bold;">üí∞ <span id="cost-${item.id}">${item.cost.toLocaleString()}</span></div>
                `;
                shopDiv.appendChild(el);
            });
            updateUI();
        }

        function updateUI() {
            document.getElementById('score').innerText = Math.floor(game.score).toLocaleString();
            document.getElementById('gps').innerText = game.gps;
            game.items.forEach(item => {
                const box = document.getElementById(`item-box-${item.id}`);
                if(box) {
                    document.getElementById(`cost-${item.id}`).innerText = item.cost.toLocaleString();
                    document.getElementById(`count-${item.id}`).innerText = item.count;
                    if (game.score >= item.cost) box.classList.remove('disabled');
                    else box.classList.add('disabled');
                }
            });
        }

        function clickHeart(event) { 
            game.score += game.clickPower; 
            spawnFloatingText(event.clientX, event.clientY, `+${game.clickPower}`);
            updateUI(); 
        }

        function buyItem(id) {
            const item = game.items[id];
            if(game.score >= item.cost) {
                game.score -= item.cost; 
                item.count++; 
                item.cost = Math.ceil(item.cost * 1.5);
                if(item.clickBoost > 0) game.clickPower += item.clickBoost;
                if(item.rate > 0) game.gps += item.rate;
                updateUI();
            }
        }

        function spawnFloatingText(x, y, text, color="#d81b60") {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text; el.style.left = `${x}px`; el.style.top = `${y}px`; el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function spawnGoldenHeart() {
            const heart = document.getElementById('golden-heart');
            const area = document.getElementById('game-area');
            const rect = area.getBoundingClientRect();
            heart.style.left = (Math.random() * (rect.width - 60)) + 'px';
            heart.style.top = (Math.random() * (rect.height - 60)) + 'px';
            heart.style.display = 'block';
            setTimeout(() => { heart.style.display = 'none'; }, 3000);
        }

        function clickGoldenHeart(e) {
            e.stopPropagation();
            document.getElementById('golden-heart').style.display = 'none';
            const bonus = game.clickPower * 500;
            game.score += bonus;
            spawnFloatingText(e.clientX, e.clientY, `+${bonus} GOLD!`, "gold");
            updateUI();
        }

        // --- EMAIL WITH AI FILTER ---
        async function sendLove() {
            const btn = document.getElementById('love-btn');
            const name = document.getElementById('letter-name');
            const msg = document.getElementById('letter-msg');
            const status = document.getElementById('love-status');

            // 1. Reset UI
            name.classList.remove('toxic-alert');
            msg.classList.remove('toxic-alert');
            btn.disabled = true; 
            btn.innerText = "AI Checking...";

            // 2. AI CHECK
            const isNameBad = await checkTextForToxicity(name.value);
            const isMsgBad = await checkTextForToxicity(msg.value);

            if (isNameBad || isMsgBad) {
                if(isNameBad) name.classList.add('toxic-alert');
                if(isMsgBad) msg.classList.add('toxic-alert');
                
                status.innerText = "‚ö†Ô∏è AI detected negativity. Please be nice!";
                btn.innerText = "Try Again";
                btn.disabled = false;
                return;
            }

            // 3. SEND IF CLEAN
            btn.innerText = "Sending...";
            emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
                to_name: 'Gattu', message: `Message from ${name.value}: ${msg.value}`
            }, EMAIL_PUBLIC_KEY).then(() => {
                btn.innerText = "Sent! ‚ù§Ô∏è";
                status.innerText = "";
            }, () => {
                btn.disabled = false; btn.innerText = "Try Again";
            });
        }

        initUI();
        setInterval(() => { if(game.gps > 0) { game.score += (game.gps / 10); updateUI(); } }, 100);
        setInterval(() => { localStorage.setItem('gattuGameData', JSON.stringify(game)); }, 5000);
        setInterval(() => { if(Math.random() > 0.7) spawnGoldenHeart(); }, 10000);
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHq9QOKiG_twwGtdZsnO1-grHWh2FXuVk",
            authDomain: "gattufanpage.firebaseapp.com",
            projectId: "gattufanpage",
            storageBucket: "gattufanpage.firebasestorage.app",
            messagingSenderId: "1000778970327",
            appId: "1:1000778970327:web:17a0f327f76129c2662c92"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let lastUpload = 0;

        window.pushScoreToFirebase = async function() {
            const nameInput = document.getElementById('gamer-name');
            const name = nameInput.value.trim();
            const status = document.getElementById('upload-status');
            const btn = document.getElementById('upload-btn');
            
            if(!name) { alert("Enter a name!"); return; }
            if (Date.now() - lastUpload < 30000) { status.innerText = "‚ö†Ô∏è Wait 30s before updating."; return; }

            // 1. AI CHECK
            status.innerText = "AI Checking Name...";
            btn.disabled = true;
            nameInput.classList.remove('toxic-alert');

            // Access the global checkTextForToxicity function
            const isToxic = await window.checkTextForToxicity(name);
            
            if(isToxic) {
                status.innerText = "‚ö†Ô∏è AI rejected this username.";
                nameInput.classList.add('toxic-alert');
                btn.disabled = false;
                return;
            }

            // 2. UPLOAD IF CLEAN
            localStorage.setItem('gattuUserName', name);
            status.innerText = "Connecting...";
            
            try {
                await setDoc(doc(db, "leaderboard", deviceID), {
                    name: name,
                    score: Math.floor(game.score),
                    timestamp: serverTimestamp()
                });
                
                status.innerText = "‚úÖ Rank Updated!";
                lastUpload = Date.now();
                window.fetchLeaderboard();
                setTimeout(() => { btn.disabled = false; }, 3000);
            } catch (error) {
                console.error(error);
                status.innerText = "‚ùå Error.";
                btn.disabled = false;
            }
        }
        
        // Expose AI function to module
        window.checkTextForToxicity = checkTextForToxicity;

        window.fetchLeaderboard = async function() {
            const tbody = document.getElementById('leaderboard-body');
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                tbody.innerHTML = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let icon = rank <= 3 ? ["ü•á","ü•à","ü•â"][rank-1] : `#${rank}`;
                    tbody.innerHTML += `<tr><td>${icon}</td><td>${data.name}</td><td>${data.score.toLocaleString()}</td></tr>`;
                    rank++;
                });
            } catch (error) { tbody.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`; }
        }
        window.fetchLeaderboard();
    </script>

</body>
</html>
